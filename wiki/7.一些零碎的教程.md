# 💡 一些零碎的教程

> 收集了一些关于 OpenClash 和 OpenWrt 的实用配置教程。

---

## 📦 1. 订阅转换相关

### 1.1. ImmortalWrt 下搭建订阅转换后端服务

出于隐私安全考虑，部分用户倾向于自建订阅转换服务而非使用公共服务。

ImmortalWrt 固件的软件源中默认包含了 `subconverter` 软件包。通过安装该软件包，可以在本地快速搭建轻量级的订阅转换后端。

**安装步骤：**

```text
1. 进入软件包界面，点击"更新列表"

2. 在过滤器中输入 subconverter

3. 找到 subconverter 软件包，点击"安装"
```

![](../doc/subconverter/subconverter.png)

通常情况下，使用默认配置即可满足需求（默认已关闭缓存），无需修改配置参数。

安装完成后，并在 `OpenClash > 配置订阅` 中，将"订阅转换服务地址"修改为：

```text
http://127.0.0.1:25500/sub
```

![](../doc/subconverter/subconverter-url.png)

**重要配置说明：**

由于 OpenClash 内置的订阅转换模板地址多为 GitHub 直链，国内网络环境下可能无法直接访问。既然使用了自建后端（运行于国内环境），建议将所有模板链接替换为加速镜像地址（如 jsDelivr 等 CDN 地址），以确保转换服务正常运行。

> [!WARNING]
> **注意**：如果本地后端无法连接 GitHub，将导致无法拉取远程模板和规则文件，后端会自动回退至内置默认模板，这将导致本项目的分流策略失效。请务必确保网络连通性或使用加速链接。

---

### 1.2. 自建订阅转换后端服务导入本地模板和规则

以 ImmortalWrt 为例，subconverter 的默认配置文件路径为 `/etc/subconverter`。

#### 导入本地模板

将自定义的 `.ini` 模板文件上传至 `/etc/subconverter/config` 目录（例如 `example.ini`）。在引用时，使用路径 `config/example.ini`。

或者，将模板文件上传至 `/etc/subconverter/base` 目录。在 OpenClash 的 `自定义模板的地址` 栏中，直接填写文件名 `example.ini` 即可调用。

![](../doc/subconverter/subconverter-local.png)

#### 导入本地规则

将规则文件（`.list`）上传至 `/etc/subconverter/rules` 目录。在模板文件中引用时，使用路径 `rules/your_rules.list`。

**配置示例：**

```ini
ruleset=🎯 全球直连,rules/your_rules.list
```

通过以上配置，即可实现完全本地化的订阅转换服务，便于自行维护模板和规则，不再依赖远程 GitHub 文件。

---

## 🖥️ 2. OpenWrt 相关

### 2.1. 固件无损扩容

使用官方发布的 OpenWrt/ImmortalWrt 固件时，可以通过 `owut` 插件配合官方 ASU (Attended Sysupgrade) 服务器，实现简便的无损扩容。该方法支持在系统升级过程中保留扩容后的分区大小。

> [!NOTE]
> 本教程基于 ext4 分区验证，squashfs 分区未经测试。

**操作步骤：**

#### 步骤 1：SSH 连接设备

#### 步骤 2：更新软件源

根据固件版本执行更新命令：

- **Snapshot 版本**：`apk update`
- **Release 版本**：`opkg update`

#### 步骤 3：安装必要插件

安装 `owut` 和 `attendedsysupgrade`：

- **Snapshot**：`apk add luci-i18n-attendedsysupgrade-zh-cn owut`
- **Release**：`opkg install luci-i18n-attendedsysupgrade-zh-cn`

#### 步骤 4：虚拟机扩容（物理机请跳过）

若运行在 PVE、ESXi 等虚拟化平台，需先在虚拟机管理界面调整虚拟磁盘大小。

#### 步骤 5：设置目标固件大小

默认情况下，`owut` 仅在当前请求中应用临时参数。配置永久参数可确保后续升级自动维持指定容量。

> [!TIP]
> 固件大小上限受 ASU 服务器限制（通常约 2GB）。一般建议设置为 1GB (1024MB)。

执行以下命令写入配置：

```bash
uci set attendedsysupgrade.owut=owut
# 设置固件大小为 1024MB (1GB)
uci set attendedsysupgrade.owut.rootfs_size='1024'
uci commit
```

#### 步骤 6：执行扩容与升级

运行升级命令。系统将请求 ASU 服务器生成指定大小的新固件，并执行下载和刷写操作。

```bash
owut upgrade --force
```

升级过程会保留现有的插件和配置。重启后，系统分区将自动扩展至设定的大小。后续维护只需再次执行该命令即可完成系统升级并保持分区容量，同时保留所有配置和已安装的插件。

![](../doc/openwrt/pics/space.png)
