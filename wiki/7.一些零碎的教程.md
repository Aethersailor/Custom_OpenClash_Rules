# ğŸ’¡ ä¸€äº›é›¶ç¢çš„æ•™ç¨‹

> æ”¶é›†äº†ä¸€äº›å…³äº OpenClash å’Œ OpenWrt çš„å®ç”¨é…ç½®æ•™ç¨‹ã€‚

---

## ç›®å½•

- 1. é…ç½®è½¬æ¢ç›¸å…³
  - 1.1. ImmortalWrt ä¸‹æ­å»ºæœ¬åœ°è½¬æ¢æœåŠ¡
  - 1.2. æœ¬åœ°è½¬æ¢æœåŠ¡å¯¼å…¥æ¨¡æ¿å’Œè§„åˆ™
- 2. OpenWrt ç›¸å…³
  - 2.1. å›ºä»¶æ— æŸæ‰©å®¹
  - 2.2. OpenWrt x Tailscale å­ç½‘äº’é€šæ–¹æ¡ˆï¼ˆfw4 / snapshotï¼‰

---

## ğŸ“¦ 1. é…ç½®è½¬æ¢ç›¸å…³

### 1.1. ImmortalWrt ä¸‹æ­å»ºæœ¬åœ°è½¬æ¢æœåŠ¡

éƒ¨åˆ†ç”¨æˆ·å€¾å‘äºåœ¨æœ¬åœ°è¿è¡Œè½¬æ¢æœåŠ¡ï¼Œé¿å…ä¾èµ–å¤–éƒ¨æœåŠ¡ã€‚

ImmortalWrt å›ºä»¶çš„è½¯ä»¶æºä¸­é»˜è®¤åŒ…å«äº† `subconverter` è½¯ä»¶åŒ…ã€‚é€šè¿‡å®‰è£…è¯¥è½¯ä»¶åŒ…ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¿«é€Ÿæ­å»ºè½»é‡çº§çš„è½¬æ¢æœåŠ¡ã€‚

**å®‰è£…æ­¥éª¤ï¼š**

```text
1. è¿›å…¥è½¯ä»¶åŒ…ç•Œé¢ï¼Œç‚¹å‡»"æ›´æ–°åˆ—è¡¨"

2. åœ¨è¿‡æ»¤å™¨ä¸­è¾“å…¥ subconverter

3. æ‰¾åˆ° subconverter è½¯ä»¶åŒ…ï¼Œç‚¹å‡»"å®‰è£…"
```

![Subconverter è½¯ä»¶åŒ…å®‰è£…ç•Œé¢](../doc/subconverter/subconverter.png)

é€šå¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨é»˜è®¤é…ç½®å³å¯æ»¡è¶³éœ€æ±‚ï¼ˆé»˜è®¤å·²å…³é—­ç¼“å­˜ï¼‰ï¼Œæ— éœ€ä¿®æ”¹é…ç½®å‚æ•°ã€‚

å®‰è£…å®Œæˆåï¼Œåœ¨ OpenClash çš„è®¢é˜…é…ç½®é¡µé¢ä¸­ï¼Œå°† `è®¢é˜…è½¬æ¢æœåŠ¡åœ°å€` ä¿®æ”¹ä¸ºï¼š

```text
http://127.0.0.1:25500/sub
```

![è®¢é˜…è½¬æ¢æœåŠ¡åœ°å€å¡«å†™](../doc/subconverter/subconverter-url.png)

**é‡è¦é…ç½®è¯´æ˜ï¼š**

ç”±äº OpenClash å†…ç½®çš„æ¨¡æ¿åœ°å€å¤šä¸º GitHub ç›´é“¾ï¼Œåœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸‹å¯èƒ½ä¸ç¨³å®šã€‚è‹¥è½¬æ¢æœåŠ¡ä¾§æ‹‰å–å¤±è´¥ï¼Œå¯å°†æ¨¡æ¿é“¾æ¥æ›¿æ¢ä¸ºå¯ç”¨çš„å¤‡ç”¨ä¸‹è½½æºï¼ˆå¦‚ jsDelivr çš„å¯¹åº”åœ°å€ï¼‰ï¼Œä»¥ç¡®ä¿è½¬æ¢æœåŠ¡æ­£å¸¸è¿è¡Œã€‚

> [!WARNING]
> **æ³¨æ„**ï¼šå¦‚æœè½¬æ¢æœåŠ¡æ— æ³•è®¿é—®æ¨¡æ¿/è§„åˆ™åœ°å€ï¼Œå°†å¯¼è‡´æ— æ³•æ‹‰å–è¿œç¨‹æ¨¡æ¿å’Œè§„åˆ™æ–‡ä»¶ï¼ŒæœåŠ¡ä¼šè‡ªåŠ¨å›é€€è‡³å†…ç½®é»˜è®¤æ¨¡æ¿ï¼Œä»è€Œå¯¼è‡´ç­–ç•¥ç»„/è§„åˆ™ç»“æ„ä¸ç¬¦åˆé¢„æœŸã€‚è¯·ç¡®ä¿è½¬æ¢æœåŠ¡ä¾§ç½‘ç»œè¿é€šæ€§æˆ–ä½¿ç”¨å¯ç”¨çš„å¤‡ç”¨ä¸‹è½½æºã€‚

---

### 1.2. æœ¬åœ°è½¬æ¢æœåŠ¡å¯¼å…¥æ¨¡æ¿å’Œè§„åˆ™

ä»¥ ImmortalWrt ä¸ºä¾‹ï¼Œsubconverter çš„é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ä¸º `/etc/subconverter`ã€‚

#### å¯¼å…¥æœ¬åœ°æ¨¡æ¿

å°†è‡ªå®šä¹‰çš„ `.ini` æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ è‡³ `/etc/subconverter/config` ç›®å½•ï¼ˆä¾‹å¦‚ `example.ini`ï¼‰ã€‚åœ¨å¼•ç”¨æ—¶ï¼Œä½¿ç”¨è·¯å¾„ `config/example.ini`ã€‚

æˆ–è€…ï¼Œå°†æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ è‡³ `/etc/subconverter/base` ç›®å½•ã€‚åœ¨ OpenClash çš„ `è‡ªå®šä¹‰æ¨¡æ¿çš„åœ°å€` æ ä¸­ï¼Œç›´æ¥å¡«å†™æ–‡ä»¶å `example.ini` å³å¯è°ƒç”¨ã€‚

![æœ¬åœ°æ¨¡æ¿è®¾ç½®](../doc/subconverter/subconverter-local.png)

#### å¯¼å…¥æœ¬åœ°è§„åˆ™

å°†è§„åˆ™æ–‡ä»¶ï¼ˆ`.list`ï¼‰ä¸Šä¼ è‡³ `/etc/subconverter/rules` ç›®å½•ã€‚åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­å¼•ç”¨æ—¶ï¼Œä½¿ç”¨è·¯å¾„ `rules/your_rules.list`ã€‚

**é…ç½®ç¤ºä¾‹ï¼š**

```ini
ruleset=ğŸ¯ å…¨çƒç›´è¿,rules/your_rules.list
```

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œå³å¯å®ç°å®Œå…¨æœ¬åœ°åŒ–çš„è½¬æ¢æœåŠ¡ï¼Œä¾¿äºè‡ªè¡Œç»´æŠ¤æ¨¡æ¿å’Œè§„åˆ™ï¼Œä¸å†ä¾èµ–è¿œç¨‹ GitHub æ–‡ä»¶ã€‚

---

## ğŸ–¥ï¸ 2. OpenWrt ç›¸å…³

### 2.1. å›ºä»¶æ— æŸæ‰©å®¹

ä½¿ç”¨å®˜æ–¹å‘å¸ƒçš„ OpenWrt/ImmortalWrt å›ºä»¶æ—¶ï¼Œå¯ä»¥é€šè¿‡ `owut` æ’ä»¶é…åˆå®˜æ–¹ ASU (Attended Sysupgrade) æœåŠ¡å™¨ï¼Œå®ç°ç®€ä¾¿çš„æ— æŸæ‰©å®¹ã€‚è¯¥æ–¹æ³•æ”¯æŒåœ¨ç³»ç»Ÿå‡çº§è¿‡ç¨‹ä¸­ä¿ç•™æ‰©å®¹åçš„åˆ†åŒºå¤§å°ã€‚

> [!NOTE]
> æœ¬æ•™ç¨‹åŸºäº ext4 åˆ†åŒºéªŒè¯ï¼Œsquashfs åˆ†åŒºæœªç»æµ‹è¯•ã€‚

**æ“ä½œæ­¥éª¤ï¼š**

#### æ­¥éª¤ 1ï¼šSSH è¿æ¥è®¾å¤‡

#### æ­¥éª¤ 2ï¼šæ›´æ–°è½¯ä»¶æº

æ ¹æ®å›ºä»¶ç‰ˆæœ¬æ‰§è¡Œæ›´æ–°å‘½ä»¤ï¼š

- **Snapshot ç‰ˆæœ¬**ï¼š`apk update`
- **Release ç‰ˆæœ¬**ï¼š`opkg update`

#### æ­¥éª¤ 3ï¼šå®‰è£…å¿…è¦æ’ä»¶

å®‰è£… `owut` å’Œ `attendedsysupgrade`ï¼š

- **Snapshot**ï¼š`apk add luci-i18n-attendedsysupgrade-zh-cn owut`
- **Release**ï¼š`opkg install luci-i18n-attendedsysupgrade-zh-cn owut`

#### æ­¥éª¤ 4ï¼šè™šæ‹Ÿæœºæ‰©å®¹ï¼ˆç‰©ç†æœºè¯·è·³è¿‡ï¼‰

è‹¥è¿è¡Œåœ¨ PVEã€ESXi ç­‰è™šæ‹ŸåŒ–å¹³å°ï¼Œéœ€å…ˆåœ¨è™šæ‹Ÿæœºç®¡ç†ç•Œé¢è°ƒæ•´è™šæ‹Ÿç£ç›˜å¤§å°ã€‚è™šæ‹Ÿç£ç›˜å¤§å°å¿…é¡»å¤§äºæˆ–ç­‰äºè°ƒæ•´åçš„å®¹é‡ã€‚  

#### æ­¥éª¤ 5ï¼šè®¾ç½®ç›®æ ‡å›ºä»¶å¤§å°

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`owut` ä»…åœ¨å½“å‰è¯·æ±‚ä¸­åº”ç”¨ä¸´æ—¶å‚æ•°ã€‚é…ç½®æ°¸ä¹…å‚æ•°å¯ç¡®ä¿åç»­å‡çº§è‡ªåŠ¨ç»´æŒæŒ‡å®šå®¹é‡ã€‚

> [!TIP]
> å›ºä»¶å¤§å°ä¸Šé™å— ASU æœåŠ¡å™¨é™åˆ¶ï¼ˆé€šå¸¸çº¦ 2GBï¼‰ã€‚ä¸€èˆ¬å»ºè®®è®¾ç½®ä¸º 1GB (1024MB)ã€‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å†™å…¥é…ç½®ï¼š

```bash
uci set attendedsysupgrade.owut=owut
# è®¾ç½®å›ºä»¶å¤§å°ä¸º 1024MB (1GB)
uci set attendedsysupgrade.owut.rootfs_size='1024'
uci commit
```

#### æ­¥éª¤ 6ï¼šæ‰§è¡Œæ‰©å®¹ä¸å‡çº§

è¿è¡Œå‡çº§å‘½ä»¤ã€‚ç³»ç»Ÿå°†è¯·æ±‚ ASU æœåŠ¡å™¨ç”ŸæˆæŒ‡å®šå¤§å°çš„æ–°å›ºä»¶ï¼Œå¹¶æ‰§è¡Œä¸‹è½½å’Œåˆ·å†™æ“ä½œã€‚

```bash
owut upgrade --force
```

å‡çº§è¿‡ç¨‹ä¼šä¿ç•™ç°æœ‰çš„æ’ä»¶å’Œé…ç½®å¹¶è‡ªåŠ¨é‡å¯ã€‚é‡å¯åï¼Œç³»ç»Ÿåˆ†åŒºå°†è‡ªåŠ¨æ‰©å±•è‡³è®¾å®šçš„å¤§å°ã€‚åç»­ç»´æŠ¤åªéœ€å†æ¬¡æ‰§è¡Œè¯¥å‘½ä»¤å³å¯å®Œæˆç³»ç»Ÿå‡çº§å¹¶ä¿æŒåˆ†åŒºå®¹é‡ï¼ŒåŒæ—¶ä¿ç•™æ‰€æœ‰é…ç½®å’Œå·²å®‰è£…çš„æ’ä»¶ã€‚

![å›ºä»¶æ‰©å®¹åçš„åˆ†åŒºå¤§å°](../doc/openwrt/pics/space.png)

---

### 2.2. OpenWrt x Tailscale å­ç½‘äº’é€šæ–¹æ¡ˆï¼ˆfw4 / snapshotï¼‰

#### 2.2.1. ç›®æ ‡

- åŸåˆ™ä¸Šæœ€å°åŒ–é…ç½®ï¼Œä¸è¿›è¡Œä»»ä½•æ— ç”¨çš„é…ç½®ä¿®æ”¹æ“ä½œ
- å¤šå° OpenWrt è·¯ç”±å™¨ä¹‹é—´å®ç°ä¸‰å±‚å­ç½‘äº’é€š
- å„è‡ªå­ç½‘å…¬ç½‘å‡ºå£ç‹¬ç«‹
- ä¸åˆå¹¶ LANï¼Œä¸äº§ç”Ÿå¹¿æ’­ / æ‰«æ
- ä»…å…è®¸é€šè¿‡æ˜ç¡® IP è®¿é—®å¯¹ç«¯
- å­ç½‘è®¾å¤‡å¢åˆ æ— éœ€è°ƒæ•´é˜²ç«å¢™è§„åˆ™
- ä¸éœ€è¦åœ¨å…¬ç½‘å¼€æ”¾ä»»ä½•ç«¯å£

#### 2.2.2. é€‚ç”¨ç¯å¢ƒ

- OpenWrt/ImmortalWrt Snapshot
- é˜²ç«å¢™ï¼šfw4 + nftables
- Tailscale ä½¿ç”¨è½¯ä»¶æºä¸­è‡ªå¸¦ç‰ˆæœ¬
- å„ LAN å­ç½‘ä¸é‡å 

ç¤ºä¾‹ï¼š

| èŠ‚ç‚¹ | å­ç½‘ |
| ---- | ---- |
| A | 192.168.1.0/24 |
| B | 192.168.2.0/24 |

#### 2.2.3. Tailscale é…ç½®ï¼ˆæ¯å°è·¯ç”±å™¨éƒ½åšï¼‰

##### 2.2.3.1. å®‰è£…å¹¶å¯åŠ¨ tailscaled

```sh
apk update
apk add tailscale
```
```sh
tailscaled &
```

ç¡®è®¤è¿è¡Œï¼š

```sh
pgrep -a tailscaled
```

##### 2.2.3.2. åŠ å…¥ Tailscale å¹¶é€šå‘Šå­ç½‘

Aï¼ˆ192.168.1.0/24ï¼‰ï¼š

```sh
tailscale up \
  --advertise-routes=192.168.1.0/24 \
  --accept-routes \
  --accept-dns=false
```

Bï¼ˆ192.168.2.0/24ï¼‰ï¼š

```sh
tailscale up \
  --advertise-routes=192.168.2.0/24 \
  --accept-routes \
  --accept-dns=false
```
SSH ç•Œé¢ä¸­ä¼šå‡ºç°ç™»å½•é“¾æ¥ï¼Œå¤åˆ¶å¹¶ç”¨æµè§ˆå™¨æ‰“å¼€åä¼šè·³è½¬ Tailscale å®˜ç½‘ï¼Œè‡ªè¡Œæ³¨å†Œæˆ–ç™»å½• Tailscale è´¦å·å³å¯ã€‚  
åœ¨æµè§ˆå™¨ä¸­ç™»å½•åï¼ŒSSH ç•Œé¢ä¼šè‡ªåŠ¨æç¤º `sucess` è¡¨ç¤ºç»‘å®šæˆåŠŸã€‚  

##### 2.2.3.3. æ§åˆ¶å°æ“ä½œï¼ˆä¸€æ¬¡æ€§ï¼‰

åœ¨ Tailscale å®˜ç½‘æ§åˆ¶å°çš„ Admin Console ä¸­ï¼š
- Approve åŒæ–¹é€šå‘Šçš„ routes

##### 2.2.3.4. è·¯ç”±ç¡®è®¤ï¼ˆå¯é€‰ï¼‰

```sh
ip route get <å¯¹ç«¯ç½‘å…³IP>
```

æœŸæœ›ç»“æœï¼š

```
dev tailscale0
```

#### 2.2.4. é˜²ç«å¢™é…ç½®ï¼ˆfw4 æ ¸å¿ƒï¼‰

> [!IMPORTANT]
> fw4 + åŠ¨æ€æ¥å£ï¼ˆ`tailscale0`ï¼‰å¿…é¡»ä½¿ç”¨ `option device`ï¼Œä¸è¦ä½¿ç”¨ `option network`ã€‚

##### 2.2.4.1. åˆ›å»º / ä¿®æ­£ tailscale zone

```sh
uci add firewall zone
uci set firewall.@zone[-1].name='tailscale'
uci set firewall.@zone[-1].device='tailscale0'
uci set firewall.@zone[-1].input='ACCEPT'
uci set firewall.@zone[-1].output='ACCEPT'
uci set firewall.@zone[-1].forward='REJECT'
```

##### 2.2.4.2. æ·»åŠ  forwardingï¼ˆä»…è¿™ä¸¤æ¡ï¼‰

```sh
uci add firewall forwarding
uci set firewall.@forwarding[-1].src='lan'
uci set firewall.@forwarding[-1].dest='tailscale'

uci add firewall forwarding
uci set firewall.@forwarding[-1].src='tailscale'
uci set firewall.@forwarding[-1].dest='lan'
```

##### 2.2.4.3. æäº¤å¹¶é‡è½½

```sh
uci commit firewall
/etc/init.d/firewall reload
```

##### 2.2.4.4. æ ¸æŸ¥ fw4 æ˜¯å¦çœŸæ­£ç”Ÿæ•ˆï¼ˆå…³é”®ï¼‰

```sh
nft list chain inet fw4 input
```

å¿…é¡»å‡ºç°ï¼š

```
iifname "tailscale0" jump input_tailscale
```

#### 2.2.5. éªŒè¯æµç¨‹ï¼ˆé¡ºåºä¸å¯ä¹±ï¼‰

##### 2.2.5.1. è·¯ç”±å™¨ <-> è·¯ç”±å™¨

```sh
ping 192.168.2.1
ping 192.168.1.1
```

##### 2.2.5.2. å­ç½‘è®¾å¤‡ <-> å­ç½‘è®¾å¤‡

```sh
ping 192.168.2.X
```

#### 2.2.6. ç»“è¯­

è¿™æ˜¯ fw4 + snapshot + Tailscale å­ç½‘è·¯ç”±çš„æ ‡å‡†æ–¹æ¡ˆï¼Œå¯é•¿æœŸå¤ç”¨ï¼Œä¸”ä¸æœ¬é¡¹ç›® OpenClash è®¾ç½®æ–¹æ¡ˆæ— ä»»ä½•å†²çªã€‚  
