æƒ³åˆ°ä»€ä¹ˆå†™ä»€ä¹ˆ

***

# 1. è®¢é˜…è½¬æ¢ç›¸å…³

## 1.1. ImmortalWrt ä¸‹æ­å»ºè®¢é˜…è½¬æ¢åç«¯æœåŠ¡  
æœ‰äº›äººå¯èƒ½ä¼šæ‹…å¿ƒä½¿ç”¨å…¬å…±è®¢é˜…è½¬æ¢æœåŠ¡ä¼šæ³„éœ²è‡ªå·±çš„è®¢é˜…é“¾æ¥ï¼Œä»è€Œé€‰æ‹©è‡ªå»ºè®¢é˜…è½¬æ¢æœåŠ¡ã€‚  

åœ¨ ImmortalWrt å›ºä»¶çš„è½¯ä»¶æºä¸­ï¼Œå·²ç»åŒ…å«äº† subconverter è½¯ä»¶åŒ…ï¼Œåªéœ€ç®€å•å‡ éƒ¨æ“ä½œå°±å¯ä»¥æ­å»ºå±äºè‡ªå·±çš„æœ¬åœ°è®¢é˜…è½¬æ¢åç«¯æœåŠ¡ã€‚  

å¦‚æœä½ çš„å›ºä»¶è½¯ä»¶æºä¸­åŒæ ·æœ‰ subconverter è½¯ä»¶åŒ…ï¼Œå¯ä»¥å‚è€ƒæ­¤æ“ä½œã€‚

å…·ä½“æ“ä½œæ­¥éª¤ï¼š 
```
1. ç‚¹å‡»â€œæ›´æ–°åˆ—è¡¨â€

2. åœ¨è¿‡æ»¤å™¨ä¸­è¾“å…¥ subconverter

3. ç‚¹å‡» subconverter è½¯ä»¶åŒ…åçš„â€œå®‰è£…â€ï¼Œå®‰è£…å¯¹åº”çš„è½¯ä»¶åŒ…  
```

![](../doc/subconverter/subconverter.png)  

æ²¡æœ‰ç‰¹æ®Šéœ€æ±‚çš„è¯ï¼Œä½¿ç”¨ subconverter çš„é»˜è®¤é…ç½®å³å¯ï¼Œé»˜è®¤é…ç½®å·²ç»å…³é—­äº†ç¼“å­˜åŠŸèƒ½ã€‚ä¹Ÿä¸éœ€è¦å»ä¿®æ”¹å®‰å…¨ç›¸å…³çš„å‚æ•°ï¼Œæ¯•ç«Ÿè¿™ä¸ªè®¢é˜…è½¬æ¢åç«¯æœåŠ¡åªæœ‰ä½ è‡ªå·±çš„å†…ç½‘å¯ç”¨ã€‚  

ç„¶ååœ¨ `OpenClash > é…ç½®è®¢é˜…`ä¸­ï¼Œå¡«å†™è‡ªå®šä¹‰è®¢é˜…è½¬æ¢æœåŠ¡åœ°å€ï¼š  
```
http://127.0.0.1:25500/sub
```

![](../doc/subconverter/subconverter-url.png)

æ¨¡æ¿é“¾æ¥å»ºè®®ä½¿ç”¨ jsDeliver çš„åŠ é€Ÿåœ°å€ï¼Œè¿é€šæ€§æ¯”è¾ƒå¥½ï¼Œæˆ–è€…å…¶ä»–åŠ é€Ÿ CDN åœ°å€ä¹Ÿè¡Œï¼Œåæ­£åˆ«ç”¨ GitHub åŸå§‹åœ°å€å°±è¡Œäº†ã€‚

ä¿å­˜å¹¶åº”ç”¨ï¼Œå³å¯å¼€å§‹ä½¿ç”¨è‡ªå»ºçš„è®¢é˜…è½¬æ¢åç«¯æœåŠ¡è¿›è¡Œè®¢é˜…ã€‚  

## 1.2. è‡ªå»ºè®¢é˜…è½¬æ¢åç«¯æœåŠ¡å¯¼å…¥æœ¬åœ°æ¨¡æ¿å’Œè§„åˆ™  

ä»¥ ImmortalWrt ä¸‹æ­å»ºçš„ subconverter ä¸ºä¾‹ï¼Œå…¶é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸º `/etc/subconverter `  

å°†ä½ è‡ªå·±ç»´æŠ¤çš„è®¢é˜…è½¬æ¢æ¨¡æ¿ .ini æ–‡ä»¶ï¼Œæ”¾ç½®åœ¨ `/etc/subconverter` ä¸‹çš„ `config` ç›®å½•ä¸­ï¼Œæ¯”å¦‚ `example.ini` æ–‡ä»¶  

åœ¨ OpenClash ä¸­é…ç½®å¥½`è®¢é˜…è½¬æ¢æœåŠ¡åœ°å€`åï¼Œåœ¨`è‡ªå®šä¹‰æ¨¡æ¿çš„åœ°å€`ä¸­ï¼Œæ— éœ€å†å¡«å†™è¿œç¨‹æ¨¡æ¿åœ°å€ï¼Œç›´æ¥å¡«å†™æ–‡ä»¶å `example.ini` ï¼Œsubconverter åœ¨è½¬æ¢æ—¶å³å¯è°ƒç”¨ä½ çš„æœ¬åœ°æ¨¡æ¿  

![](../doc/subconverter/subconverter-local.png)  

å¯¹äºè§„åˆ™æ–‡ä»¶`.list`æ–‡ä»¶ï¼Œå¯ä»¥æ”¾ç½®åœ¨ `/etc/subconverter` ä¸‹çš„ `rules` ç›®å½•ä¸­ï¼Œåœ¨è®¢é˜…è½¬æ¢æ¨¡æ¿ä¸­ä½¿ç”¨æœ¬åœ°åœ°å€è¿›è¡Œè°ƒç”¨å³å¯ã€‚  

ä¾‹å¦‚ï¼š  
```
ruleset=ğŸ¯ å…¨çƒç›´è¿,rules/your_rules.list
```

å¦‚æ­¤é…ç½®åï¼Œä½ çš„è®¢é˜…è½¬æ¢å®Œå…¨å¯ä»¥è„±ç¦»è¿œç¨‹æ–‡ä»¶è¿è¡Œï¼Œå¯ä»¥ç›´æ¥åœ¨æœ¬åœ°è¿›è¡Œç»´æŠ¤æ¨¡æ¿å’Œè§„åˆ™ï¼Œæ— éœ€å†ä¸Šä¼  GitHubã€‚  

***

# 2. OpenClash ç›¸å…³

## 2.1. æœ¬é¡¹ç›®æ–¹æ¡ˆå¦‚ä½•ä½¿ç”¨ Smart å†…æ ¸  

Smart å†…æ ¸æ˜¯ OpenClash ä½œè€… vernesong æ¨å‡ºçš„é­”æ”¹ç‰ˆå†…æ ¸ï¼Œæ”¯æŒ Smart ç­–ç•¥ç»„åŠŸèƒ½ï¼Œæœ‰ç‚¹ç±»ä¼¼ Load-balanceï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ç­–ç•¥ç»„ã€‚

å†…æ ¸ç‰¹æ€§ï¼šhttps://github.com/vernesong/OpenClash/releases/tag/mihomo  

æœ¬é¡¹ç›®çš„æ¨¡æ¿ç›®å‰éƒ½æ˜¯ä½¿ç”¨çš„ Url-testï¼ˆè‡ªåŠ¨æµ‹é€Ÿï¼‰ç­–ç•¥ç»„ï¼Œç”±äºè®¢é˜…è½¬æ¢åç«¯æš‚æ—¶è¿˜ä¸æ”¯æŒ Smart ç­–ç•¥ç»„ï¼Œæ‰€ä»¥è¯·æŒ‰ç…§ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤å®ç°å¯¹ Url-test ç­–ç•¥ç»„çš„è‡ªåŠ¨æ›¿æ¢ã€‚

### 2.1.1. æ›´æ¢ Smart å†…æ ¸

åœ¨ OpenClash `æ’ä»¶è®¾ç½® > ç‰ˆæœ¬æ›´æ–°`ä¸­ï¼Œå°† `Smart å†…æ ¸`é€‰æ‹©ä¸º`å¯ç”¨`ï¼Œç„¶åç›´æ¥ç‚¹å‡»ä¸‹æ–¹å†…æ ¸å¤„çš„`æ£€æŸ¥å¹¶æ›´æ–°`æŒ‰é’®ã€‚ 
 
æ³¨æ„é€‰æ‹©å¯ç”¨å**åˆ‡å‹¿**ç‚¹ä¿å­˜ï¼ŒåŠ¡å¿…**ç›´æ¥**ç‚¹æ›´æ–°ã€‚ 

> æ²¡æœ‰ Smart å†…æ ¸é€‰é¡¹çš„ï¼Œè¯·æ›´æ–° OpenClash è‡³æœ€æ–°ç‰ˆã€‚

![](../doc/openclash/pics/smart-core-update.png)

OpenClash å³ä¼šæ›´æ–°ä¸º Smart å†…æ ¸ã€‚

### 2.1.2. ä¿®æ”¹â€œå¼€å‘è€…é€‰é¡¹â€  

è¿›å…¥ `è¦†å†™è®¾ç½® > å¼€å‘è€…é€‰é¡¹` é¡µé¢ï¼Œæ³¨æ„æ˜¯`è¦†å†™è®¾ç½®`ä¸‹çš„`å¼€å‘è€…é€‰é¡¹`ï¼Œ**ä¸æ˜¯**`æ’ä»¶è®¾ç½®`ä¸‹çš„å¼€å‘è€…é€‰é¡¹ã€‚

å¤åˆ¶ä»¥ä¸‹ä»£ç ï¼Œæ’å…¥åœ¨åŸæœ‰å†…å®¹çš„`CONFIG_FILE="$1"`ä¹‹åï¼Œ`exit 0`ä¹‹å‰ã€‚  

> ä»£ç æ¥è‡ªäº OpenClash æ’ä»¶ä½œè€…åœ¨å…¶ä»– TG ç¾¤ç»„ä¸­å‘å¸ƒçš„æ¶ˆæ¯ã€‚

```
ruby -ryaml -rYAML -I "/usr/share/openclash" -E UTF-8 -e "
  Value = YAML.load_file('$CONFIG_FILE');
  if Value.key?('proxy-groups') then
    Value['proxy-groups'].each{|group|
      if ['url-test'].include?(group['type']) then
        group['type'] = 'smart';
      end;
    };
  end;
  File.open('$CONFIG_FILE','w') {|f| YAML.dump(Value, f)};
" 2>/dev/null >> $LOG_FILE
```

å…·ä½“ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  

![](../doc/openclash/pics/smart-core.png)  

ç„¶ååº”ç”¨é…ç½®ï¼ŒOpenClash åœ¨æ¯æ¬¡å¯åŠ¨æ—¶å³ä¼šå°†åŸæœ‰é…ç½®ä¸­çš„æ‰€æœ‰ Url-test è‡ªåŠ¨æµ‹é€Ÿç­–ç•¥ç»„æ›¿æ¢ä¸º Smart ç­–ç•¥ç»„ã€‚  

### 2.1.3. Smart å†…æ ¸ä¸“ç”¨æ¨¡æ¿  

å¯ä»¥é€‰æ‹©ä½¿ç”¨æœ¬é¡¹ç›®çš„ Smart å†…æ ¸ä¸“ç”¨æ¨¡æ¿ï¼Œæ¯ä¸ªæ¨¡æ¿å‡æœ‰ä¸€ä¸ªå¯¹åº”çš„ Smart å†…æ ¸ä¸“ç”¨ç‰ˆæœ¬ã€‚  

åœ¨åŸæœ‰æ¨¡æ¿çš„é“¾æ¥ä¸­çš„æ–‡ä»¶åéƒ¨åˆ†æ·»åŠ  `_Smart` å³å¯åˆ‡æ¢ä¸º Smart æ¨¡æ¿ã€‚  

```
https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/cfg/Custom_Clash_Smart.ini
```
```
https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/cfg/Custom_Clash_Smart_Lite.ini
```
```
https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/cfg/Custom_Clash_Smart_GFW.ini
```
```
https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/cfg/Custom_Clash_Smart_Full.ini
```

æ­¤ç±»æ¨¡æ¿çš„èŠ‚ç‚¹åœ°åŒºåˆ†ç»„ä»…ä¿ç•™åœ°åŒºåˆ†ç»„ï¼Œä»¥ä¾¿æ›´å¥½çš„é€‚åº” Smart ç­–ç•¥ç»„çš„ç‰¹æ€§ã€‚  

### 2.1.4. æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆ  

å¯åŠ¨ä»»æ„ dashboardï¼Œè§‚å¯Ÿç­–ç•¥ç»„æ˜¯å¦ä¸º Smartã€‚  

![](../doc/openclash/pics/smart-dashboard.png)  

Smart ç­–ç•¥ç»„çš„æœ€ä½³ä½¿ç”¨æ–¹å¼æ˜¯æ¯ä¸ªç­–ç•¥ç»„å‡ä½¿ç”¨ç›¸åŒåœ°åŒºçš„èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œè¯·å‹¿å†ä½¿ç”¨â€œè‡ªåŠ¨é€‰æ‹©â€ç­–ç•¥ç»„ï¼Œä½¿ç”¨è¯¥ç­–ç•¥ç»„ä¼šé€ æˆ IP ä¹±è·³åœ°åŒºçš„æƒ…å†µã€‚  

å¾…è®¢é˜…è½¬æ¢åç«¯æ›´æ–°åï¼Œä¼šæ¨å‡º Smart ä¸“ç”¨æ¨¡æ¿ã€‚  


å› ä¸ºæ¨èæœºåœºçš„èŠ‚ç‚¹è´¨é‡ç›¸å½“å¥½ï¼Œæ‰€ä»¥æˆ‘è‡ªå·±å¹¶æ²¡æœ‰ä½¿ç”¨ Smart å†…æ ¸ã€‚  

æ‰€ä»¥ï¼ŒSmart ç­–ç•¥ç»„çš„ç›¸å…³é—®é¢˜å°±ä¸è¦é—®æˆ‘äº†å“ˆã€‚  