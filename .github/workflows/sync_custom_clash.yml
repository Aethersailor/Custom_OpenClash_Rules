name: Sync and Modify Custom_Clash.ini

on:
  push:
    branches:
      - main
    paths:
      - cfg/Custom_Clash.ini # å½“ Custom_Clash.ini æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  workflow_dispatch: # æ·»åŠ æ‰‹åŠ¨è§¦å‘äº‹ä»¶

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest
    steps:
      # Step 1: æ£€å‡ºæºä»“åº“
      - name: Checkout Source Repo
        uses: actions/checkout@v3

      # Step 2: å…‹éš†ç›®æ ‡ä»“åº“
      - name: Clone Target Repo
        run: |
          git clone https://github.com/Aethersailor/Custom_Clash_Rules.git target-repo
          cd target-repo
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

      # Step 3: ä¿®æ”¹æ–‡ä»¶
      - name: Modify File
        run: |
          # å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
          cp cfg/Custom_Clash.ini target-repo/cfg/Custom_Clash_Full.ini
          
          # è¿›å…¥ç›®æ ‡ä»“åº“
          cd target-repo
          
          # åˆ é™¤ [custom] ä¹‹å‰çš„å†…å®¹ï¼ˆä¿ç•™ [custom] è¡Œæœ¬èº«ï¼‰
          sed -i '1,/^\[custom\]/ { /^[[]custom[]]/!d }' cfg/Custom_Clash_Full.ini
          
          # æ·»åŠ å†…å®¹åˆ°æ–‡ä»¶å¼€å¤´å¹¶åŠ ä¸¤ä¸ªç©ºè¡Œ
          sed -i '1i ;Custom_Clash_Rules\n;å…¨åˆ†ç»„é˜² DNS æ³„æ¼è®¢é˜…è½¬æ¢æ¨¡æ¿\n;ä½œè€…ï¼šhttps://github.com/Aethersailor\n;é¡¹ç›®åœ°å€ï¼šhttps://github.com/Aethersailor/Custom_Clash_Rules\n;è¯¥è®¢é˜…æ¨¡æ¿ä¸º Custom_OpenClash_Rules é¡¹ç›®çš„è¡ç”Ÿé¡¹ç›®\n;åŸºäº ACL4SSR æ¨¡æ¿é­”æ”¹è€Œæ¥ï¼Œæ„Ÿè°¢åŸä½œè€…ï¼\n\n' cfg/Custom_Clash_Full.ini
          
          # åˆ é™¤å·²æœ‰çš„è§„åˆ™è¡Œ
          sed -i '/ruleset=ğŸ¯ å…¨çƒç›´è¿,[]GEOSITE,cn/d' cfg/Custom_Clash_Full.ini
          sed -i '/ruleset=ğŸ¯ å…¨çƒç›´è¿,[]GEOIP,cn,no-resolve/d' cfg/Custom_Clash_Full.ini
          
          # åœ¨åŒ…å« "Custom_Proxy" çš„è¡Œåæ·»åŠ ä¸¤è¡Œå†…å®¹
          sed -i '/Custom_Proxy/a ruleset=ğŸ¯ å…¨çƒç›´è¿,[]GEOSITE,cn\nruleset=ğŸ¯ å…¨çƒç›´è¿,[]GEOIP,cn,no-resolve' cfg/Custom_Clash_Full.ini

      # Step 4: æäº¤æ›´æ”¹åˆ°ç›®æ ‡ä»“åº“
      - name: Commit and Push Changes
        run: |
          cd target-repo
          git add .
          git commit -m "Update Custom_Clash_Full.ini based on Custom_Clash.ini"
          git push https://$TARGET_REPO_TOKEN@github.com/Aethersailor/Custom_Clash_Rules.git main
        env:
          TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}