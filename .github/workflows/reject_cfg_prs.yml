name: Reject CFG Directory PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'cfg/**'

jobs:
  check-and-reject:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if PR is from GitHub Actions or repository owner
        id: check-actor
        run: |
          # Get the list of changed files in the PR
          changed_files=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' | grep "^cfg/" || echo "")
          
          # Check if Custom_Clash_Full.ini is the only cfg file being modified
          if [[ "$changed_files" == "cfg/Custom_Clash_Full.ini" ]]; then
            echo "is_allowed=true" >> $GITHUB_OUTPUT
            echo "reason=excluded_file" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.user.login }}" == "github-actions[bot]" ]]; then
            echo "is_allowed=true" >> $GITHUB_OUTPUT
            echo "reason=github_actions" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.pull_request.user.login }}" == "Aethersailor" ]]; then
            echo "is_allowed=true" >> $GITHUB_OUTPUT
            echo "reason=repository_owner" >> $GITHUB_OUTPUT
          else
            echo "is_allowed=false" >> $GITHUB_OUTPUT
            echo "reason=unauthorized_user" >> $GITHUB_OUTPUT
          fi
          
          echo "PR author: ${{ github.event.pull_request.user.login }}"
          echo "Changed cfg files: $changed_files"
          echo "Is allowed: ${{ steps.check-actor.outputs.is_allowed }}"
          echo "Reason: ${{ steps.check-actor.outputs.reason }}"

      - name: Reject unauthorized PRs
        if: steps.check-actor.outputs.is_allowed == 'false'
        run: |
          echo "ğŸš« Rejecting PR #${{ github.event.pull_request.number }}"
          echo "Reason: Unauthorized user trying to modify /cfg directory"
          echo "Only GitHub Actions and repository owner can modify files in the /cfg directory"
          
          # Add a comment to the PR
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## âŒ PR Rejected / PR è¢«æ‹’ç»

          This PR has been automatically rejected because it contains modifications to files in the `/cfg` directory.
          æ­¤ PR å·²è¢«è‡ªåŠ¨æ‹’ç»ï¼Œå› ä¸ºå®ƒåŒ…å«å¯¹ `/cfg` ç›®å½•æ–‡ä»¶çš„ä¿®æ”¹ã€‚

          ### Why was this rejected? / ä¸ºä»€ä¹ˆè¢«æ‹’ç»ï¼Ÿ
          - Modifying `.ini` template files will affect all users' configured node options
          - ä¿®æ”¹ `.ini` æ¨¡æ¿æ–‡ä»¶ä¼šå½±å“æ‰€æœ‰ç”¨æˆ·å·²è®¾ç½®çš„èŠ‚ç‚¹é€‰é¡¹
          - Except for the Full template, other templates do not accept any PRs
          - é™¤äº† Full æ¨¡æ¿ä»¥å¤–ï¼Œå…¶ä»–æ¨¡æ¿ä¸æ¥å—ä»»ä½• PR
          - This ensures configuration integrity and prevents disruption to existing user setups
          - è¿™ç¡®ä¿äº†é…ç½®å®Œæ•´æ€§å¹¶é˜²æ­¢ç ´åç°æœ‰ç”¨æˆ·è®¾ç½®
          - Only GitHub Actions workflows and repository owner can modify these files
          - åªæœ‰ GitHub Actions å·¥ä½œæµå’Œä»“åº“æ‰€æœ‰è€…å¯ä»¥ä¿®æ”¹è¿™äº›æ–‡ä»¶

          ### What should you do? / ä½ åº”è¯¥æ€ä¹ˆåšï¼Ÿ
          - If you need to modify configuration files, please fork and modify for your own use
          - å¦‚æœä½ éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè¯· fork ä»¥åä¿®æ”¹è‡ªç”¨
          - If you believe this rejection is in error, please contact the repository maintainers
          - å¦‚æœä½ è®¤ä¸ºæ­¤æ‹’ç»æ˜¯é”™è¯¯çš„ï¼Œè¯·è”ç³»ä»“åº“ç»´æŠ¤è€…

          ---
          *This is an automated response from the repository protection system.*
          *è¿™æ˜¯æ¥è‡ªä»“åº“ä¿æŠ¤ç³»ç»Ÿçš„è‡ªåŠ¨å›å¤ã€‚*"

      - name: Close unauthorized PRs
        if: steps.check-actor.outputs.is_allowed == 'false'
        run: |
          gh pr close ${{ github.event.pull_request.number }} \
            --delete-branch \
            --reason "not_planned"

      - name: Allow authorized PRs
        if: steps.check-actor.outputs.is_allowed == 'true'
        run: |
          echo "âœ… Allowing PR #${{ github.event.pull_request.number }}"
          echo "Reason: This PR was created by ${{ steps.check-actor.outputs.reason }}"
          
          # Add a comment to confirm it's allowed
          if [[ "${{ steps.check-actor.outputs.reason }}" == "github_actions" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "## âœ… PR Allowed / PR è¢«å…è®¸

          This PR has been automatically allowed because it was created by GitHub Actions.
          æ­¤ PR å·²è¢«è‡ªåŠ¨å…è®¸ï¼Œå› ä¸ºå®ƒæ˜¯ç”± GitHub Actions åˆ›å»ºçš„ã€‚

          ### Why was this allowed? / ä¸ºä»€ä¹ˆè¢«å…è®¸ï¼Ÿ
          - This PR was created by a GitHub Actions workflow
          - æ­¤ PR æ˜¯ç”± GitHub Actions å·¥ä½œæµåˆ›å»ºçš„
          - Automated updates to `/cfg` directory are permitted
          - å…è®¸å¯¹ `/cfg` ç›®å½•è¿›è¡Œè‡ªåŠ¨åŒ–æ›´æ–°
          - The changes are part of the automated configuration generation process
          - è¿™äº›æ›´æ”¹æ˜¯è‡ªåŠ¨åŒ–é…ç½®ç”Ÿæˆè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†

          ---
          *This is an automated response from the repository protection system.*
          *è¿™æ˜¯æ¥è‡ªä»“åº“ä¿æŠ¤ç³»ç»Ÿçš„è‡ªåŠ¨å›å¤ã€‚*"
          elif [[ "${{ steps.check-actor.outputs.reason }}" == "excluded_file" ]]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "## âœ… PR Allowed / PR è¢«å…è®¸

          This PR has been allowed because it only modifies `Custom_Clash_Full.ini`.
          æ­¤ PR å·²è¢«å…è®¸ï¼Œå› ä¸ºå®ƒåªä¿®æ”¹ `Custom_Clash_Full.ini`ã€‚

          ### Why was this allowed? / ä¸ºä»€ä¹ˆè¢«å…è®¸ï¼Ÿ
          - `Custom_Clash_Full.ini` is excluded from protection rules
          - `Custom_Clash_Full.ini` è¢«æ’é™¤åœ¨ä¿æŠ¤è§„åˆ™ä¹‹å¤–
          - This file can be modified by any user
          - ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä¿®æ”¹æ­¤æ–‡ä»¶
          - Other `/cfg` directory files remain protected
          - å…¶ä»– `/cfg` ç›®å½•æ–‡ä»¶ä»ç„¶å—åˆ°ä¿æŠ¤

          ---
          *This is an automated response from the repository protection system.*
          *è¿™æ˜¯æ¥è‡ªä»“åº“ä¿æŠ¤ç³»ç»Ÿçš„è‡ªåŠ¨å›å¤ã€‚*"
          else
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "## âœ… PR Allowed / PR è¢«å…è®¸

          This PR has been allowed because it was created by the repository owner.
          æ­¤ PR å·²è¢«å…è®¸ï¼Œå› ä¸ºå®ƒæ˜¯ç”±ä»“åº“æ‰€æœ‰è€…åˆ›å»ºçš„ã€‚

          ### Why was this allowed? / ä¸ºä»€ä¹ˆè¢«å…è®¸ï¼Ÿ
          - This PR was created by the repository owner
          - æ­¤ PR æ˜¯ç”±ä»“åº“æ‰€æœ‰è€…åˆ›å»ºçš„
          - Repository owners have full access to modify files in this directory
          - ä»“åº“æ‰€æœ‰è€…æ‹¥æœ‰ä¿®æ”¹æ­¤ç›®å½•æ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™
          - Manual modifications by the owner are permitted
          - å…è®¸æ‰€æœ‰è€…è¿›è¡Œæ‰‹åŠ¨ä¿®æ”¹

          ---
          *This is an automated response from the repository protection system.*
          *è¿™æ˜¯æ¥è‡ªä»“åº“ä¿æŠ¤ç³»ç»Ÿçš„è‡ªåŠ¨å›å¤ã€‚*"
          fi

      - name: Show PR Details
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "PR Title: ${{ github.event.pull_request.title }}"
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          echo "PR URL: ${{ github.event.pull_request.html_url }}"
          echo "Changed Files:"
          gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path' 