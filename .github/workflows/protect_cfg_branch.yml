name: Protect CFG Directory Branch

on:
  push:
    paths:
      - 'cfg/**'

jobs:
  check-and-block:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if push is from GitHub Actions or repository owner
        id: check-actor
        run: |
          # Get the list of changed cfg files
          changed_cfg_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^cfg/" || echo "")
          
          # Check if only Custom_Clash_Full.ini is being modified
          if [[ "$changed_cfg_files" == "cfg/Custom_Clash_Full.ini" ]]; then
            echo "is_allowed=true" >> $GITHUB_OUTPUT
            echo "reason=excluded_file" >> $GITHUB_OUTPUT
          elif [[ "${{ github.actor }}" == "github-actions[bot]" ]]; then
            echo "is_allowed=true" >> $GITHUB_OUTPUT
            echo "reason=github_actions" >> $GITHUB_OUTPUT
          elif [[ "${{ github.actor }}" == "Aethersailor" ]]; then
            echo "is_allowed=true" >> $GITHUB_OUTPUT
            echo "reason=repository_owner" >> $GITHUB_OUTPUT
          else
            echo "is_allowed=false" >> $GITHUB_OUTPUT
            echo "reason=unauthorized_user" >> $GITHUB_OUTPUT
          fi
          
          echo "Push author: ${{ github.actor }}"
          echo "Changed cfg files: $changed_cfg_files"
          echo "Is allowed: ${{ steps.check-actor.outputs.is_allowed }}"
          echo "Reason: ${{ steps.check-actor.outputs.reason }}"

      - name: Block unauthorized pushes
        if: steps.check-actor.outputs.is_allowed == 'false'
        run: |
          echo "ðŸš« Blocking push to ${{ github.ref }}"
          echo "Reason: Unauthorized user trying to modify /cfg directory"
          echo "Only GitHub Actions and repository owner can modify files in the /cfg directory"
          
          # Create a status check that will fail
          echo "## âŒ Push Blocked / æŽ¨é€è¢«é˜»æ­¢" > status.md
          echo "" >> status.md
          echo "This push has been automatically blocked because it contains modifications to files in the `/cfg` directory." >> status.md
          echo "æ­¤æŽ¨é€å·²è¢«è‡ªåŠ¨é˜»æ­¢ï¼Œå› ä¸ºå®ƒåŒ…å«å¯¹ `/cfg` ç›®å½•æ–‡ä»¶çš„ä¿®æ”¹ã€‚" >> status.md
          echo "" >> status.md
          echo "### Why was this blocked? / ä¸ºä»€ä¹ˆè¢«é˜»æ­¢ï¼Ÿ" >> status.md
          echo "- Modifying `.ini` template files will affect all users' configured node options" >> status.md
          echo "- ä¿®æ”¹ `.ini` æ¨¡æ¿æ–‡ä»¶ä¼šå½±å“æ‰€æœ‰ç”¨æˆ·å·²è®¾ç½®çš„èŠ‚ç‚¹é€‰é¡¹" >> status.md
          echo "- Except for the Full template, other templates do not accept any PRs" >> status.md
          echo "- é™¤äº† Full æ¨¡æ¿ä»¥å¤–ï¼Œå…¶ä»–æ¨¡æ¿ä¸æŽ¥å—ä»»ä½• PR" >> status.md
          echo "- This ensures configuration integrity and prevents disruption to existing user setups" >> status.md
          echo "- è¿™ç¡®ä¿äº†é…ç½®å®Œæ•´æ€§å¹¶é˜²æ­¢ç ´åçŽ°æœ‰ç”¨æˆ·è®¾ç½®" >> status.md
          echo "- Only GitHub Actions workflows and repository owner can modify these files" >> status.md
          echo "- åªæœ‰ GitHub Actions å·¥ä½œæµå’Œä»“åº“æ‰€æœ‰è€…å¯ä»¥ä¿®æ”¹è¿™äº›æ–‡ä»¶" >> status.md
          echo "" >> status.md
          echo "### What should you do? / ä½ åº”è¯¥æ€Žä¹ˆåšï¼Ÿ" >> status.md
          echo "- If you need to modify configuration files, please fork and modify for your own use" >> status.md
          echo "- å¦‚æžœä½ éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè¯· fork ä»¥åŽä¿®æ”¹è‡ªç”¨" >> status.md
          echo "- If you believe this block is in error, please contact the repository maintainers" >> status.md
          echo "- å¦‚æžœä½ è®¤ä¸ºæ­¤é˜»æ­¢æ˜¯é”™è¯¯çš„ï¼Œè¯·è”ç³»ä»“åº“ç»´æŠ¤è€…" >> status.md
          
          # Exit with error to fail the workflow
          exit 1

      - name: Allow authorized pushes
        if: steps.check-actor.outputs.is_allowed == 'true'
        run: |
          echo "âœ… Allowing push to ${{ github.ref }}"
          echo "Reason: This push was created by ${{ steps.check-actor.outputs.reason }}"
          
          # Create a status check that will pass
          echo "## âœ… Push Allowed / æŽ¨é€è¢«å…è®¸" > status.md
          echo "" >> status.md
          if [[ "${{ steps.check-actor.outputs.reason }}" == "github_actions" ]]; then
            echo "This push has been automatically allowed because it was created by GitHub Actions." >> status.md
            echo "æ­¤æŽ¨é€å·²è¢«è‡ªåŠ¨å…è®¸ï¼Œå› ä¸ºå®ƒæ˜¯ç”± GitHub Actions åˆ›å»ºçš„ã€‚" >> status.md
            echo "" >> status.md
            echo "### Why was this allowed? / ä¸ºä»€ä¹ˆè¢«å…è®¸ï¼Ÿ" >> status.md
            echo "- This push was created by a GitHub Actions workflow" >> status.md
            echo "- æ­¤æŽ¨é€æ˜¯ç”± GitHub Actions å·¥ä½œæµåˆ›å»ºçš„" >> status.md
            echo "- Automated updates to `/cfg` directory are permitted" >> status.md
            echo "- å…è®¸å¯¹ `/cfg` ç›®å½•è¿›è¡Œè‡ªåŠ¨åŒ–æ›´æ–°" >> status.md
            echo "- The changes are part of the automated configuration generation process" >> status.md
            echo "- è¿™äº›æ›´æ”¹æ˜¯è‡ªåŠ¨åŒ–é…ç½®ç”Ÿæˆè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†" >> status.md
          elif [[ "${{ steps.check-actor.outputs.reason }}" == "excluded_file" ]]; then
            echo "This push has been allowed because it only modifies Custom_Clash_Full.ini." >> status.md
            echo "æ­¤æŽ¨é€å·²è¢«å…è®¸ï¼Œå› ä¸ºå®ƒåªä¿®æ”¹ Custom_Clash_Full.iniã€‚" >> status.md
            echo "" >> status.md
            echo "### Why was this allowed? / ä¸ºä»€ä¹ˆè¢«å…è®¸ï¼Ÿ" >> status.md
            echo "- Custom_Clash_Full.ini is excluded from protection rules" >> status.md
            echo "- Custom_Clash_Full.ini è¢«æŽ’é™¤åœ¨ä¿æŠ¤è§„åˆ™ä¹‹å¤–" >> status.md
            echo "- This file can be modified by any user" >> status.md
            echo "- ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä¿®æ”¹æ­¤æ–‡ä»¶" >> status.md
            echo "- Other /cfg directory files remain protected" >> status.md
            echo "- å…¶ä»– /cfg ç›®å½•æ–‡ä»¶ä»ç„¶å—åˆ°ä¿æŠ¤" >> status.md
          else
            echo "This push has been allowed because it was created by the repository owner." >> status.md
            echo "æ­¤æŽ¨é€å·²è¢«å…è®¸ï¼Œå› ä¸ºå®ƒæ˜¯ç”±ä»“åº“æ‰€æœ‰è€…åˆ›å»ºçš„ã€‚" >> status.md
            echo "" >> status.md
            echo "### Why was this allowed? / ä¸ºä»€ä¹ˆè¢«å…è®¸ï¼Ÿ" >> status.md
            echo "- This push was created by the repository owner" >> status.md
            echo "- æ­¤æŽ¨é€æ˜¯ç”±ä»“åº“æ‰€æœ‰è€…åˆ›å»ºçš„" >> status.md
            echo "- Repository owners have full access to modify files in this directory" >> status.md
            echo "- ä»“åº“æ‰€æœ‰è€…æ‹¥æœ‰ä¿®æ”¹æ­¤ç›®å½•æ–‡ä»¶çš„å®Œå…¨è®¿é—®æƒé™" >> status.md
            echo "- Manual modifications by the owner are permitted" >> status.md
            echo "- å…è®¸æ‰€æœ‰è€…è¿›è¡Œæ‰‹åŠ¨ä¿®æ”¹" >> status.md
          fi

      - name: Show Push Details
        run: |
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Changed Files:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep "^cfg/" || echo "No cfg files changed" 